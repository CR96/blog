---
import { sanityClient } from "sanity:client";
import groq from "groq";
import CaptionedElement from "./CaptionedElement.astro";
import type { Post, MuxVideoAsset } from '../groq';

type NodeProps = Extract<Post['content'][number], { '_type': 'video' }>;

const { video, caption } : NodeProps = Astro.props.node;
const { asset: assetReference } = video;

const assetReferenceQuery = groq`
    *[_type == "mux.videoAsset" && _id == $id][0]
`;

const asset = await sanityClient.fetch<MuxVideoAsset>(assetReferenceQuery, {
    id: assetReference?._ref
});

const WrapperElement = caption ? CaptionedElement : Fragment;
---

<WrapperElement { ...caption && { caption } }>
    <mux-player playback-id={ asset.playbackId } />
</WrapperElement>
<script>
    import '@mux/mux-player';
</script>
<style>
    mux-player {
        aspect-ratio: 16 / 9;
        --media-accent-color: var(--blue-700);
        border-radius: 0.5rem;
        overflow: hidden;
    }
</style>