---
export const prerender =  false;

import { sanityClient } from 'sanity:client';
import groq from 'groq';
import PostPage from '../[...slug].astro';
import type { InferGetStaticPropsType } from 'astro';
import type { getStaticPaths } from '../[...slug].astro';

const previewPostPageQuery = groq`
    *[
        _type == "post" &&
        datePublished == $datePublished &&
        slug.current == $slug
    ]{
        ...,
        topic->
    }[0]
`;

const { slug } = Astro.params;

const slugComponents = slug?.split('/');
if (slugComponents?.length != 4) {
    return new Response("HTTP 400", { status: 400 });
}

const datePublished = slugComponents.slice(0, 3).join('-');
const slugRoot = slugComponents.at(-1);

type PostPageQueryResult = InferGetStaticPropsType<typeof getStaticPaths>;

const post = await sanityClient.fetch<PostPageQueryResult>(previewPostPageQuery, {
    datePublished,
    slug: slugRoot
}, {
    perspective: 'previewDrafts'
});

if (!post) {
    return new Response("HTTP 400", { status: 400 });
}
---

<PostPage { ...post } />